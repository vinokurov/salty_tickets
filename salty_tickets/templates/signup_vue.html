{% extends "signup.html" %}
{% import "bootstrap/wtf.html" as wtf %}

{% block og_meta %}
<meta property="og:title" content="Mind the Shag 2018">
<meta property="og:image" content="{{ url_for('static', filename='events/{}/event_preview.jpg'.format(event.key), _external=True) }}">
<meta property="og:url" content="{{ url_for('register_form', event_key=event.key, _external=True) }}">
<meta property="og:description"
      content="Born out of London's premier fast-dance night, Salty Mondays, and now in its 2nd edition,
      the gang wants to invite you to: 'Mind the Shag 2018'.
      This Shag weekend will bring top international teachers to London to give a shot of energy to your Shag dancing.">
{% endblock %}

{% macro mts_station(product_key) %}
    {% set form_field = form.get_product_by_key(product_key) %}
    {% set product_model = event.products[product_key] %}
    <slt-mts-station
            input-name="{{ form_field.add.id }}"
            v-model=""
            time="{{product_model.start_datetime}}"
            teachers="{{product_model.teachers}}"
            lines="{{product_model.level}}"
            :available="10"
            :waiting-list-leader="10"
            :waiting-list-follower="10"
            :waiting-list-leader-with-partner="10"
            :waiting-list-follower-with-partner="10"
            :partner-mode="partnerMode"
            :fixed="fixed.{{product_key}}"
            title="{{ product_model.name }}">
        {{form_field.info}}
    </slt-mts-station>
{% endmacro %}

{% block styles %}
    <!-- Bootstrap -->
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <!--<link href="https://maxcdn.bootstrapcdn.com/bootswatch/4.0.0-beta.2/cosmo/bootstrap.min.css" rel="stylesheet" integrity="sha384-52tWTPZ1e5eK+C2aGPCgDjrEgVkKMO+0qDuRNj3tS2EugIrICHWqkGuLu442CP2S" crossorigin="anonymous">-->
    <!--<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css" integrity="sha384-PsH8R72JQ3SOdhVi3uxftmaW6Vc51MKb0q5P2rRUpPvrszuE4W1povHYgTpBfshb" crossorigin="anonymous">-->
    <!--<link href="https://maxcdn.bootstrapcdn.com/bootswatch/4.0.0-beta.2/materia/bootstrap.min.css" rel="stylesheet" integrity="sha384-R+kYzDq5OFDdI+l7v1cirgERabnAjhsBDXv0qCEtj+6z2r8BO2glDZzj49QgdxEj" crossorigin="anonymous">-->
    <!--<link href="https://maxcdn.bootstrapcdn.com/bootswatch/4.0.0-beta.2/sandstone/bootstrap.min.css" rel="stylesheet" integrity="sha384-edd69ybiwhmqlbDyKzPlHgWOcJrJhTgKQx1B2gD2yZArS8Qn2oTOYg+9X2AZRNDr" crossorigin="anonymous">-->
    <!--<link href="https://maxcdn.bootstrapcdn.com/bootswatch/4.0.0-beta.2/sketchy/bootstrap.min.css" rel="stylesheet" integrity="sha384-9BaUahJwNez+jmowV4jSdSdZIlie6a+VnhBnuzVvBPdvUPC3dDLYIg31Tgw5UzLP" crossorigin="anonymous">-->
    <!--<link href="https://maxcdn.bootstrapcdn.com/bootswatch/4.0.0-beta.2/yeti/bootstrap.min.css" rel="stylesheet" integrity="sha384-02r837f/s1bBitm4EH65RIncWtMiZuhCgUp9H4txuXwrPXSwn+vQ5YF9KqryUe7z" crossorigin="anonymous">-->
    <!--<link href="https://maxcdn.bootstrapcdn.com/bootswatch/4.0.0-beta.2/lumen/bootstrap.min.css" rel="stylesheet" integrity="sha384-rGAkR2qts0FfeepPEwAKdA+KLiTct+OBJ7ukPPivL86aKZa39nuOS0Yj6Sy8ebLR" crossorigin="anonymous">-->
    <!--<link href="https://maxcdn.bootstrapcdn.com/bootswatch/4.0.0-beta.2/slate/bootstrap.min.css" rel="stylesheet" integrity="sha384-nu0Rfs+Ud66mJzSLRuWBCMvk17+i5WBRPdLmS2djwI7YXUHlBLBsc1dHdgPyLsFO" crossorigin="anonymous">-->
    <link href="https://maxcdn.bootstrapcdn.com/bootswatch/4.0.0-beta.2/united/bootstrap.min.css" rel="stylesheet" integrity="sha384-lZV2BQHhlIeSX0KKlcV52T0RM5GEd+q4DbVOu45FyIjjgDGbbaHaVMkUMviDDeOU" crossorigin="anonymous">
    <!--<link type="text/css" rel="stylesheet" href="//unpkg.com/bootstrap@next/dist/css/bootstrap.min.css"/>-->
    <link type="text/css" rel="stylesheet" href="/static/bootstrap-vue.css"/>
    <!--<link type="text/css" rel="stylesheet" href="http://getbootstrap.com/assets/css/docs.min.css"/>-->
<style>
[v-cloak] { display:none; }

body{
   min-width:1000px; /* suppose you want minimum width of 1000px */
   width: auto !important;  /* Firefox will set width as auto */
   width:1000px;             /* As IE ignores !important it will set width as 1000px; */
}

header {
    background-image:url(/static/events/mind_the_shag_2018/event_cover.jpg);
    background-repeat:no-repeat;
    background-attachment:scroll;
    background-position:center center;
    -webkit-background-size:cover;
    -moz-background-size:cover;
    background-size:cover;
    -o-background-size:cover;
    text-align:center;
}
header .intro-text {
    padding-top: 100px;
    padding-bottom: 50px
}

@media (max-width: 400px) {
  .btn-responsive {
    white-space: normal;
    font-size:75%;
  }
}
</style>

{% endblock %}


{% block content %}
<div id="salty_app">

    <header class="bg-dark text-light">
        <div class="container">
          <div class="intro-text">
              <h3 class="display-5">6-8 April 2018</h3>
              <h3 class="display-5">London</h3>
              <h2 class="display-4"><a class="text-light" href="http://mindtheshag.co.uk">Mind the Shag</a></h2>
          </div>
        </div>
    </header>
    <header class="sticky-top bg-dark py-1 mb-1">
        <div class="container">
            <div class="row">
                <div class="col-3"><h3 class="display-5">
                    <a href="#order_summary_container" id="order_summary_total" class="text-white" v-cloak>Total: [[ checkout.total ]]</a>
                </h3></div>
                <div class="col">
                    <button type="button"
                            class="btn btn-dark btn-outline-light button-checkout"
                            @click="updateData(doCheckout=true)"
                            :disabled="disableCheckout">
                        <i class="fa fa-shopping-cart fa-fw" aria-hidden="true"></i>
                        <span class="checkout-text">Checkout</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

     <form class="form form-vertical" method="post" role="form">
        <div id="form_fields">

            <div class="container-fluid">
                <div class="container my-4">
                    <h3 >Sunday Classes</h3>
                    <table class="table bg-primary">
                        <tbody>
                        <tr>
                            <td>{{ mts_station('saturday') }}</td>
                        </tr>
                        <tr>
                            <td>{{ mts_station('sunday') }}</td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>

           <div class="container-fluid">
               <div class="container">
                   <div class="card bg-light text-black">
                       <div class="card-body">
                           <h2> Your details</h2>
          {{ form.stripe_token }}
          {{ form.csrf_token }}
                           <b-input-group class="my-2">
                                <b-input-group-addon><fa-icon name="user"></fa-icon></b-input-group-addon>
                                <b-form-input id="{{form.name.id}}" class="form-control"
                                              name="{{form.name.id}}" placeholder="Your name" @change="updateData()"></b-form-input>
                           </b-input-group>
                           <b-input-group class="my-2">
                                <b-input-group-addon><fa-icon name="envelope"></fa-icon></b-input-group-addon>
                                <b-form-input id="{{form.email.id}}" class="form-control"
                                              name="{{form.email.id}}" placeholder="Your email"></b-form-input>
                           </b-input-group>
                           <slt-input-location name-city="city" name-state="state" name-country="country"></slt-input-location>

                           <div v-if="requiresPartner">
                               <div class="form-group">{{ form.dance_role.label.text }}{{ form.dance_role(class='form-control') }}</div>

                               <h2> Your partner details</h2>
                               <small>(*If you are buying tickets for yourself and for your partner)</small>
                               <b-input-group class="my-2">
                                    <b-input-group-addon><fa-icon name="user"></fa-icon></b-input-group-addon>
                                    <b-form-input id="{{form.partner_name.id}}" class="form-control"
                                                  name="{{form.partner_name.id}}" placeholder="Your partner name"></b-form-input>
                               </b-input-group>
                               <b-input-group class="my-2">
                                    <b-input-group-addon><fa-icon name="envelope"></fa-icon></b-input-group-addon>
                                    <b-form-input id="{{form.partner_email.id}}" class="form-control"
                                                  name="{{form.partner_email.id}}" placeholder="Your partner email"></b-form-input>
                               </b-input-group>
                               <slt-input-location name-city="partner_city" name-state="partner_state" name-country="partner_country"></slt-input-location>
                           </div>
                            <hr>
                           <textarea class="form-control" id="comment"
                                          name="comment" placeholder="Any comments"></textarea>

                       </div>
                   </div>
               </div>
           </div>


        </div>
     </form>

    <div class="container-fluid" id="order_summary_container">
       <div class="container my-4">
            <div class="card card-default">
                <div class="card-body">
                    <h4 class="card-title">Order Summary</h4>
                    <div id="order_summary" v-html="orderSummaryHtml"></div>
                    <div class="form-group form-vertical">
                        <button type="button"
                                class="btn btn-lg btn-responsive btn-success form-control button-checkout"
                                @click="updateData(doCheckout=true)"
                                :disabled="disableCheckout">
                            <i class="fa fa-shopping-cart fa-fw" aria-hidden="true"></i>
                            <span class="checkout-text">Checkout</span>
                        </button>
                    </div>
                </div>
            </div>
       </div>
    </div>

    <b-modal  size="lg" ref="checkoutModal" hide-footer title="Checkout">
      <div class="d-block">
          <h3><fa-icon name="shopping-cart"></fa-icon> Order Summary</h3>
          <div id="order_summary_modal" v-html="orderSummaryHtml"></div>
          <button class="btn btn-success my-4" @click="pay()"><fa-icon name="credit-card"></fa-icon> Register and pay</button>
      </div>
    </b-modal>

    <b-modal  size="lg" ref="errorsModal" hide-footer title="There are some errors!">
      <div class="d-block text-danger">
          <ul class="list-group">
              <li class="list-group-item list-group-item-danger" v-for="(error_value, error_key) in errors"><b>[[error_key]]</b>: [[ error_value ]]</li>
          </ul>
      </div>
    </b-modal>

</div>

{#
<div class="container my-4">
    <button class="btn btn-danger btn-lg" onclick="console.log($('form').serialize());">DEBUG FORM</button>
</div>
#}
{% endblock %}

{% block scripts %}

<script src="https://cdn.jsdelivr.net/npm/vue"></script>
<script src="https://cdn.polyfill.io/v2/polyfill.min.js"></script>
<script src="/static/bootstrap-vue.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.17.1/axios.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script src="https://checkout.stripe.com/checkout.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tween.js@16.3.4"></script>

{# ================================================================================================================== #}
{# ================================================================================================================== #}
{#                                  VUE COMPONENTS                                                                    #}
{# ================================================================================================================== #}
{# ================================================================================================================== #}



{# ------------------------------------------------------------------------------------------------------------------ #}
{#                                  Vue Component: fa-icon                                                            #}
{# ------------------------------------------------------------------------------------------------------------------ #}
<script>

Vue.component('fa-icon', {
  template: '<i :class="classStr" aria-hidden="true"></i>',
  props: ['name'],
  computed: {
    classStr: function() { return 'fa fa-fw fa-' + this.name; }
  },
  delimiters: ['[[',']]']
})
</script>

{# ------------------------------------------------------------------------------------------------------------------ #}
{#                                  Vue Component: slt-input-location                                                 #}
{# ------------------------------------------------------------------------------------------------------------------ #}

<script type="text/x-template" id="slt-input-location-template">
<b-form-group
  :invalid-feedback="locationInvalidFeedback"
  :valid-feedback="locationValidFeedback"
  :state="state"
  class="my-3"
>
    <b-input-group>
        <b-input-group-addon><fa-icon name="map-marker"></fa-icon></b-input-group-addon>
        <b-form-input placeholder="Location (country, state, city, etc.)" v-model="locationQuery"></b-form-input>
    </b-input-group>
    <input type="hidden" :name="nameCity" v-if="nameCity" :value="locationCity">
    <input type="hidden" :name="nameState" v-if="nameState" :value="locationState">
    <input type="hidden" :name="nameCountry" v-if="nameCountry" :value="locationCountry">
    <input type="hidden" :name="nameLocation" v-if="nameLocation" :value="locationFull">
</b-form-group>
</script>

<script>
Vue.component('slt-input-location', {
    template: '#slt-input-location-template',
    props: ['nameCity', 'nameState', 'nameCountry', 'nameLocation', 'value', 'options', 'size'],
    data: function() {
        return {
            locationQuery: null,
            locationFull: null,
            locationCity: null,
            locationState: null,
            locationCountry: null,
            locationInvalidFeedback: null,
            locationValidFeedback: null,
            lastQuery: null,
        }
    },
    methods: {
        updateLocation: function() {
            //console.log('start location query: ', this.locationQuery);
            if (this.locationQuery) {
                if (this.locationQuery != this.lastQuery) {
                    var url = 'https://nominatim.openstreetmap.org/search/' + encodeURI(this.locationQuery) +'?format=json&addressdetails=1&limit=1&accept-language=en';
                    //console.log(url);
                    axios.get(url)
                    .then(response => {
                        this.lastQuery = this.locationQuery;
                        if(response.data.length > 0) {
                            this.locationFull = response.data[0]['display_name'];

                            var data_address = response.data[0]['address'];
                            this.locationCountry = data_address['country'];
                            if ('state' in data_address) { this.locationState = data_address['state'];}

                            if ('city' in data_address) { this.locationCity = data_address['city'];}
                            else if ('town' in data_address) { this.locationCity = data_address['town'];}
                            else if ('village' in data_address) { this.locationCity = data_address['village'];}
                            else if ('county' in data_address) { this.locationCity = data_address['county'];}

                            this.locationInvalidFeedback = null;
                            this.locationValidFeedback = this.locationFull;
                        } else {
                            this.locationInvalidFeedback = 'Location not found...';
                            this.locationValidFeedback = null;
                        }
                    })
                    .catch(function (error) {
                        console.log(error);
                        this.locationInvalidFeedback = 'Location service error...';
                        this.locationValidFeedback = null;
                    });
                }
            } else {
                this.locationInvalidFeedback = null;
                this.locationValidFeedback = null;

                this.locationFull = null;
                this.locationCity = null;
                this.locationState = null;
                this.locationCountry = null;

                this.lastQuery = null;
            }
        }
    },
    watch: {
        locationQuery: function() {
            setTimeout(function() {this.updateLocation()}.bind(this), 2000)
        }
    },
    computed: {
        state: function () {
            if (this.locationInvalidFeedback) {
                return false;
            } else if (this.locationFull) {
                return true;
            } else return null;
        }
    },
    delimiters: ['[[',']]']
});
</script>


{# ------------------------------------------------------------------------------------------------------------------ #}
{#                                  Vue Component: slt-mts-group-form                                                 #}
{# ------------------------------------------------------------------------------------------------------------------ #}

<script type="text/x-template" id="slt-mts-group-form-template">
    <div class="container-fluid">
        <div class="container my-4">
          <b-card bg-variant="light" text-variant="black">
            <h3 class="card-title">
                <fa-icon name="users"></fa-icon>
                Are you part of a group?
            </h3>
              <p class="card-text ma-4 mb-2">Members of groups having 3 and more couples coming from outside London get a £10 discount for the Full Weekend and Fast Train tickets</p>
              <input type="hidden" name="group_discount-group_participation" :value="choice">
            <b-tabs class="mb-4" pills v-model="tabIndex">
              <b-tab title="Join Existing Group" title-link-class="btn-outline-dark">
                  <b-form-group
                      id="group_discount-group_token-fieldset"
                      label-for="group_discount-group_token"
                      :invalid-feedback="tokenInvalidFeedback"
                      :valid-feedback="tokenValidFeedback"
                      :state="tokenState"
                      class="my-3"
                  >
                    <b-input-group>
                        <b-input-group-addon><fa-icon name="key"></fa-icon></b-input-group-addon>
                        <b-form-input id="group_discount-group_token" :state="tokenState" v-model.trim="groupToken"
                                      name="group_discount-group_token" placeholder="Group code (grp_ABCdE)"></b-form-input>
                    </b-input-group>
                  </b-form-group>
              </b-tab>
              <b-tab title="Create New Group" title-link-class="btn-outline-dark">
                  <b-form-group
                      id="group_discount-group_name-fieldset"
                      label-for="group_discount-group_name"
                      :invalid-feedback="newGroupInvalidFeedback"
                      valid-feedback="New group OK!"
                      :state="newGroupState"
                      class="my-3"
                  >
                    <b-input-group>
                        <b-input-group-addon><fa-icon name="users"></fa-icon></b-input-group-addon>
                        <b-form-input id="group_discount-group_name" :state="tokenState" v-model.trim="groupName"
                                      name="group_discount-group_name" placeholder="Group name"></b-form-input>
                    </b-input-group>
                  </b-form-group>
                  <slt-input-location name-location="group_discount-location"></slt-input-location>
                  <textarea class="form-control" id="group_discount-group_description"
                                          name="group_discount-group_description" placeholder="Group description"></textarea>
              </b-tab>
            </b-tabs>
          </b-card>
        </div>
    </div>
</script>
<script>
Vue.component('slt-mts-group-form', {
  template: '#slt-mts-group-form-template',
  props: ['tokenInvalidFeedback', 'tokenValidFeedback', 'newGroupInvalidFeedback'],
  data: function () {
      return {
        tabIndex: 0,
        groupName: null,
        groupToken: null,
      };
  },
  computed: {
    choice: function() {
        return ['existing', 'new'][this.tabIndex];
    },
    tokenState : function() {
        if (this.tokenInvalidFeedback) {
            return false;
        } else if (this.tokenValidFeedback) {
            return true;
        } else {
            return null;
        }
    },
    newGroupState : function() {
        if (this.newGroupInvalidFeedback) {
            return false;
        } else if (this.groupName) {
            return true;
        } else {
            return null;
        }
    },
  },
  watch: {
    groupName: function() {this.$emit('change', this.groupName)},
    groupToken: function() {this.$emit('change', this.groupToken)},
  },
  delimiters: ['[[',']]']
})
</script>

{# ------------------------------------------------------------------------------------------------------------------ #}
{#                                  Vue Component: slt-radiobutton                                                    #}
{# ------------------------------------------------------------------------------------------------------------------ #}

<script type="text/x-template" id="slt-radiobutton-template">
  <div>
    <b-button-group :size="size">
      <b-button v-for="btn in options"
                :pressed.sync="btn.state"
                :variant="btn.variant"
                :disabled="btn.disabled"
                :key="btn.value"
                @click="updateSelection(btn.value)"
      >
        [[ btn.caption ]]
      </b-button>
    </b-button-group>
      <input type="hidden" :name="name" :value="value" v-if="value">
  </div>
</script>

<script>
Vue.component('slt-radiobutton', {
    template: '#slt-radiobutton-template',
    props: ['name', 'value', 'options', 'size', 'fixed'],
    watch: {
        value: function() {
            for(i=0;i<this.options.length;i++) {
                if ( this.options[i].value == this.value ) {
                    this.options[i].state = true;
                } else {
                    this.options[i].state = false;
                }
            }
        }
    },
    methods: {
        updateSelection: function (val) {
            if (this.value == val) {
                if (!this.fixed) {
                    this.value = null;
                    this.$emit('input', null);
                }
            } else {
                this.value = val;
                this.$emit('input', String(this.value));
            }
        }
    },
    delimiters: ['[[',']]']
});
</script>

{# ------------------------------------------------------------------------------------------------------------------ #}
{#                                  Vue Component: slt-mts-station                                                    #}
{# ------------------------------------------------------------------------------------------------------------------ #}

<script type="text/x-template" id="slt-mts-station-template">
<b-card no-body :bg-variant="cardStyle[0]" :text-variant="cardStyle[1]">
    <div class="card-body">
        <span class="close" :id="inputName + '-info'"><fa-icon name="info-circle"></fa-icon></span>
        <b-popover :target="inputName + '-info'" triggers="click blur"><slot></slot></b-popover>
        <h5 class="card-title"><fa-icon name="lock" v-if="fixed"></fa-icon> [[title]]</h5>
        <slt-radiobutton :name="inputName" :options="buttonOptions" :fixed="fixed" v-model="choice" size="sm" v-if="!soldOut"></slt-radiobutton>
    </div>
    <div class="card-footer">
        <small class="text-muted"><fa-icon name="clock-o"></fa-icon> [[ time ]]</small>
        <small class="text-muted"><fa-icon name="id-badge"></fa-icon> [[ teachers ]]</small><br>
        <span v-if="isFastTrain"><fa-icon name="subway"></fa-icon> </span>
        <b-badge pill v-for="line in lineBadges" :variant="line.variant">[[line.name]]</b-badge>
        <br v-if="availableWarningText">
        <b-badge :variant="availableWarningStyle" v-if="availableWarningText">
          <fa-icon name="exclamation-circle"></fa-icon> [[availableWarningText]]
        </b-badge>
    </div>
</b-card>
</script>

<script>
Vue.component('slt-mts-station', {
  template: '#slt-mts-station-template',
  props: {
    price: {type: String},
    icon: {default:'ticket', type: String},
    inputName: {type:String},
    title: {type:String},
    lines: {type:String},
    available: {type:Number},
    waitingListLeader: {type:Number, default:0},
    waitingListFollower: {type:Number, default:0},
    waitingListLeaderWithPartner: {type:Number, default:0},
    waitingListFollowerWithPartner: {type:Number, default:0},
    isFastTrain: {type:Boolean, default:false},
    time: {type:String},
    teachers: {type:String},
    choice: {type:String},
    partnerMode: {type:String, default:null},
    fixed: {type:Boolean, default:false},
  },
  model: {
    prop: 'choice',
    event: 'input',
  },
  computed: {
        cardStyle: function() {
           if( this.soldOut ) {
                return ['secondary', 'black'];
           } else if( this.choice ) {
                return ['dark', 'light'];
           } else {
                return ['light', 'black'];
           }
        },
        lineBadges: function (){
            linesArr = this.lines.split(',');
            badges = [];
            mapping = {
                'Jitterbug': 'success',
                'Collegiate': 'warning',
                'Collegiate Super': 'warning',
                'Collegiate Light': 'warning',
                'St.Louis': 'primary',
            };
            for(i=0;i<linesArr.length;i++) {
                badges.push({name: linesArr[i], variant: mapping[linesArr[i]]});
            }
            return badges;
        },
        availableWarningStyle: function () {
            if (this.available <= 0) {
                return 'light';
            } else {
                return 'danger';
            }
        },
        availableWarningText: function () {
            if (this.available > 15) {
                return '';
            } else if (this.available <= 0) {
                return 'SOLD OUT...';
            } else if (this.available == 1) {
                return 'LAST PLACE!!!';
            } else {
                return 'Just '+this.available+' places left!';
            }
        },
        soldOut: function() {
            return this.available <= 0;
        },
        buttonOptions: function() {
            if (this.partnerMode == 'single') {
                if (this.choice == 'couple') this.choice = 'leader';
            } else if (this.partnerMode == 'couple') {
                if (this.choice ) this.choice = 'couple';
            }

            buttons = [
                {variant: 'outline-success', caption: 'Leader', value: 'leader', state: this.choice=='leader', disabled: false },
                {variant: 'outline-success', caption: 'Follower', value: 'follower', state: this.choice=='follower', disabled: false },
                {variant: 'outline-success', caption: 'Couple', value: 'couple', state: this.choice=='couple', disabled: false },
            ]

            if (this.soldOut) {
                for (i=0;i<buttons.length;i++) {
                    buttons[i].disabled = true;
                }
            }

            if (this.waitingListLeader) {
                buttons[0].variant = 'outline-warning';
            }
            if (this.waitingListFollower) {
                buttons[1].variant = 'outline-warning';
            }
            if (this.waitingListLeaderWithPartner + this.waitingListFollowerWithPartner) {
                buttons[2].variant = 'outline-warning';
            }

            // partner mode: single, couple or none
            if (this.partnerMode == 'single') {
                buttons[0].disabled = false;
                buttons[1].disabled = false;
                buttons[2].disabled = true;
            } else if (this.partnerMode == 'couple') {
                buttons[0].disabled = true;
                buttons[1].disabled = true;
                buttons[2].disabled = false;
            } else {
                buttons[0].disabled = false;
                buttons[1].disabled = false;
                buttons[2].disabled = false;
            }

            return buttons;
        }
  },
  watch: {
    choice: function() {
        this.$emit('input', this.choice);
        this.$emit('change', this.choice);
    }
  },
  delimiters: ['[[',']]']
})
</script>


{# ================================================================================================================== #}
{# ================================================================================================================== #}
{#                                         VUE APP                                                                    #}
{# ================================================================================================================== #}
{# ================================================================================================================== #}


<script>


var salty_app = new Vue({
  el: '#salty_app',

  data: {
    pricing_data: {{init_pricing_data.to_json()|safe}},
    errors: {},
    checkout : {
       total: '£0',
    },
    disableCheckout: true,
    products: { {% for product_key in form.product_keys %}
        {{ product_key }}: {
            available: 999,
            keywords: [],
            includes: [],
            waitingList: {
                leader: null,
                follower: null,
                leaderWithPartner: null,
                followerWithPartner: null,
            },
        }, {% endfor %}
    },
    fixed: {},
    stripeData: {},
    refreshed: true,
    totalStations: 0,
    totalStationsAnimated: 0,
    remainingStations: 495,
    remainingStationsAnimated:495,
  },

  computed: {
    requiresPartner: function() {
        return false;
    },
    partnerMode: function() {
        return null;
    },
  },

  watch: {
    //selection_stations: {
    //    handler: function (val, oldVal) {
    //        setTimeout(function() {this.updateData()}.bind(this), 500);
    //    },
    //    deep: true,
    //},
    pricing_data: {
        handler: function (val, oldVal) {
            console.log(val);
            console.log(oldVal);
        },
        deep: true,
    }
  },

  methods: {
    updateData: function(doCheckout=false) {
        var url = "{{ url_for('register_get_price', event_key=event.key) }}"; // send the form data here.
        this.refreshed = false;
        setTimeout( function() {
            post_data = $('form').serialize();
            axios.post(url, post_data)
                    .then(function(response) {
                        console.log(response.data);  // display the returned data in the console.
                        //for(var form_field_id in response.data.errors)
                        //{
                        //    // force reload page if CSFR token is expired
                        //    if(form_field_id=='csrf_token'){window.location.reload();}
                        //}
                        this.pricing_data = response.data
                        this.refreshed = true;
                    }).catch(function (error) {
                        console.log(error);
                    });
            }, 500);
    },
    processCheckout: function() {
        this.$refs.checkoutModal.show();
    },
    pay: function() {
            var handler = StripeCheckout.configure({
              key: '{{ config.STRIPE_PK }}',
              image: 'https://stripe.com/img/documentation/checkout/marketplace.png',
              locale: 'auto',
              token: function(token) {
                // You can access the token ID with `token.id`.
                // Get the token ID to your server-side code for use.
                //console.log(token)
                $('#{{ form.stripe_token.id }}').val(token.id);
                $('form').submit()
              }
            });

            if (this.stripeData.amount > 0) {
                handler.open({
                    name: 'Salty Jitterbugs Ltd.',
                    description: '{{ event.name | safe}}',
                    currency: 'gbp',
                    amount: this.stripeData.amount,
                    email: this.stripeData.email,
                    zipCode: true,
                    billingAddress: true,
                    allowRememberMe: false
                })
            } else {
                $('form').submit();
            }
    }
  },
  created: function() { console.log(this);this.updateData() },

  delimiters: ['[[',']]']
})
</script>

{% endblock %}